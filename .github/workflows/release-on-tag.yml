name: Release Firmware on Tag

on:
  push:
    tags:
      - 'v*.*.*.*'
      - 'v*.*.*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"

          # Strip any suffix (e.g., -test, -alpha, -rc1)
          VERSION_CLEAN="${VERSION%%-*}"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Convert version to hex for fileVersion (use clean version for numbers)
          IFS='.' read -r major minor patch <<< "$VERSION_CLEAN"
          if [ -z "$patch" ]; then patch=0; fi

          # Calculate hex fileVersion: (major << 16) | (minor << 8) | patch
          # Format: 0x00MMNNPP where MM=major, NN=minor, PP=patch
          file_version_dec=$((major * 65536 + minor * 256 + patch))
          file_version=$(printf "0x%08x" $file_version_dec)

          echo "file_version_hex=${file_version}" >> $GITHUB_OUTPUT
          echo "file_version_dec=${file_version_dec}" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Release version: ${VERSION}"
          echo "ðŸ“¦ Version (clean): ${VERSION_CLEAN}"
          echo "ðŸ”¢ File version (hex): ${file_version}"
          echo "ðŸ”¢ File version (dec): ${file_version_dec}"

      - name: Validate version in code
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          MAJOR="${{ steps.version.outputs.major }}"
          MINOR="${{ steps.version.outputs.minor }}"
          PATCH="${{ steps.version.outputs.patch }}"

          # Check main/version.h for version component constants
          if ! grep -q "#define FW_VERSION_MAJOR ${MAJOR}" main/version.h; then
            echo "âŒ ERROR: FW_VERSION_MAJOR mismatch in main/version.h"
            echo "Expected: #define FW_VERSION_MAJOR ${MAJOR}"
            echo "Please update main/version.h to match tag ${GITHUB_REF#refs/tags/}"
            exit 1
          fi

          if ! grep -q "#define FW_VERSION_MINOR ${MINOR}" main/version.h; then
            echo "âŒ ERROR: FW_VERSION_MINOR mismatch in main/version.h"
            echo "Expected: #define FW_VERSION_MINOR ${MINOR}"
            echo "Please update main/version.h to match tag ${GITHUB_REF#refs/tags/}"
            exit 1
          fi

          if ! grep -q "#define FW_VERSION_PATCH ${PATCH}" main/version.h; then
            echo "âŒ ERROR: FW_VERSION_PATCH mismatch in main/version.h"
            echo "Expected: #define FW_VERSION_PATCH ${PATCH}"
            echo "Please update main/version.h to match tag ${GITHUB_REF#refs/tags/}"
            exit 1
          fi

          echo "âœ… Version validated in code"

      - name: Install ESP-IDF dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget flex bison gperf python3 python3-pip \
            python3-venv cmake ninja-build ccache libffi-dev libssl-dev dfu-util \
            libusb-1.0-0

      - name: Clone ESP-IDF
        run: |
          git clone --recursive --branch v5.5.2 --depth 1 https://github.com/espressif/esp-idf.git
          cd esp-idf
          ./install.sh esp32h2

      - name: Clone ESP Zigbee SDK
        run: |
          cd esp-idf/..
          git clone --recursive --branch main --depth 1 https://github.com/espressif/esp-zigbee-sdk.git
          ls -la esp-zigbee-sdk/tools/image_builder_tool/

      - name: Build firmware
        run: |
          . esp-idf/export.sh
          idf.py set-target esp32h2
          idf.py build

          echo "âœ… Firmware built successfully"
          ls -lh build/zb_led_controller.bin

      - name: Install zigpy for OTA image creation
        run: |
          python3 -m pip install zigpy

      - name: Create OTA image
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          FILE_VERSION_HEX="${{ steps.version.outputs.file_version_hex }}"

          python3 esp-zigbee-sdk/tools/image_builder_tool/image_builder_tool.py \
            -c zb_led_controller_v${VERSION}.ota \
            -v ${FILE_VERSION_HEX} \
            -m 0x131B \
            -i 0x0002 \
            -f build/zb_led_controller.bin

          echo "âœ… OTA image created"
          ls -lh zb_led_controller_v${VERSION}.ota

      - name: Generate release notes
        id: release_notes
        run: |
          # Get previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "First release - no previous tag found"
            NOTES="Initial release"
          else
            echo "Generating changelog from ${PREVIOUS_TAG} to ${GITHUB_REF#refs/tags/}"
            NOTES=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          fi

          # Save to file for multiline output
          echo "${NOTES}" > release_notes.txt
          echo "notes_file=release_notes.txt" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"

          gh release create "${TAG}" \
            zb_led_controller_v${VERSION}.ota \
            --title "ZB-H2-LED ${TAG}" \
            --notes-file ${{ steps.release_notes.outputs.notes_file }}

          echo "âœ… GitHub release created: ${TAG}"

      - name: Update OTA index
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          FILE_VERSION_DEC="${{ steps.version.outputs.file_version_dec }}"

          # Create/update OTA index
          cat > z2m/ota_index.json <<EOF
          [
            {
              "manufacturerCode": 4891,
              "imageType": 2,
              "fileVersion": ${FILE_VERSION_DEC},
              "url": "https://github.com/${{ github.repository }}/releases/download/${TAG}/zb_led_controller_v${VERSION}.ota"
            }
          ]
          EOF

          echo "âœ… OTA index updated"
          cat z2m/ota_index.json

      - name: Commit and push OTA index
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add z2m/ota_index.json
          git diff --staged --quiet || git commit -m "chore: update OTA index for ${TAG}"
          git push origin HEAD:master

          echo "âœ… OTA index committed and pushed"

      - name: Trigger OTA index aggregator
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/ShaunPCcom/zigbee-ota-index/dispatches \
            -d '{"event_type":"update-index","client_payload":{"repository":"zigbee-LED-ESP32-controller","version":"'"${VERSION}"'"}}'

          echo "âœ… Triggered OTA index aggregator update"

      - name: Release Summary
        run: |
          echo "ðŸŽ‰ Release Complete!"
          echo ""
          echo "ðŸ“¦ Version: ${{ steps.version.outputs.version }}"
          echo "ðŸ·ï¸  Tag: ${{ steps.version.outputs.tag }}"
          echo "ðŸ“„ OTA File: zb_led_controller_v${{ steps.version.outputs.version }}.ota"
          echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
          echo ""
          echo "Users will be notified of the update within 24 hours (or on manual check)."
